<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SkipTheDishes ‚Äî Zone Change Request (PDF + Email)</title>

  <!-- Tailwind (optional but retained earlier) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- html2canvas and jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <meta name="theme-color" content="#f97316" />

  <style>
    :root{
      --accent: #f97316;
      --accent-dark: #c65308;
      --muted: #6b7280;
      --bg: #fbfcff;
      --card-radius: 14px;
      --fee: 499.90;
    }

    html,body { height:100%; }
    body{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#ffffff,var(--bg));
      color: #052135;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      margin:0;
      padding:0;
    }

    /* FULL-PAGE LOADER (3D pulse) */
    #pageLoader {
      position: fixed;
      inset: 0;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      transition: opacity .6s ease;
      will-change: opacity;
      perspective: 1200px;
    }
    .loader-wrap { display:flex; flex-direction:column; align-items:center; gap:.8rem; }
    .loader-ball {
      width: 36px;
      height: 36px;
      background: linear-gradient(180deg,var(--accent),var(--accent-dark));
      border-radius: 50%;
      animation: pop3D 0.9s infinite cubic-bezier(.2,.9,.3,1);
      box-shadow: 0 10px 24px rgba(249,115,22,0.16);
      transform-origin: center;
      will-change: transform, box-shadow;
    }
    @keyframes pop3D {
      0% { transform: translateZ(0) scale(1); box-shadow: 0 6px 18px rgba(249,115,22,0.12); }
      50% { transform: translateZ(30px) scale(1.28); box-shadow: 0 22px 56px rgba(2,6,23,0.16); }
      100% { transform: translateZ(0) scale(1); box-shadow: 0 6px 18px rgba(249,115,22,0.12); }
    }
    .loader-text { color:var(--muted); font-size:14px; }

    /* Layout container */
    .container {
      max-width: 980px;
      margin: 1.8rem auto;
      padding: 1rem;
    }

    h1 { font-weight: 800; font-size: 1.35rem; margin:0; color:#052135; }
    .lead { color:var(--muted); font-size: .95rem; margin-top:.45rem; }

    /* Card */
    .card {
      background: linear-gradient(180deg,#fff,#fbfdff);
      border-radius: var(--card-radius);
      padding: 1rem;
      box-shadow: 0 12px 36px rgba(4,10,30,0.06);
      overflow: visible;
      transform-style: preserve-3d;
    }

    label { display:block; font-weight: 600; color:#0f172a; margin-bottom:.35rem; font-size:.95rem; }
    input[type="text"], input[type="email"] {
      width:100%;
      padding:.7rem .85rem;
      border-radius: 10px;
      border: 1px solid rgba(2,6,23,0.06);
      background: #fff;
      font-size: 1rem;
    }
    input[readonly] { background:#f6f7fb; color:#39404b; cursor:default; }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(180deg,var(--accent),var(--accent-dark));
      color:white;
      padding:.75rem 1rem;
      border-radius: 12px;
      font-weight:700;
      border:none;
      box-shadow: 0 12px 36px rgba(249,115,22,0.18);
      display:inline-flex;
      gap:.6rem;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .12s ease, opacity .12s;
    }
    .btn-primary:active { transform: translateY(2px); }
    .btn-primary[disabled] { opacity:.6; cursor:not-allowed; transform:none; box-shadow:none; }

    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(2,6,23,0.06);
      padding:.6rem .9rem;
      border-radius:10px;
      cursor:pointer;
    }

    .info {
      font-size:.94rem; color:var(--muted);
    }

    /* Payment options (3D cards) */
    .payments { display:flex; gap:12px; flex-wrap:wrap; margin-top:10px; }
    .pay-card {
      flex: 1 1 140px;
      min-width: 130px;
      background: linear-gradient(180deg,#ffffff,#fbfdff);
      border-radius:12px;
      padding:12px;
      border:1px solid rgba(2,6,23,0.06);
      box-shadow: 0 10px 22px rgba(2,6,23,0.06);
      display:flex;
      gap:8px;
      align-items:center;
      cursor:pointer;
      transition: transform .26s cubic-bezier(.2,.9,.2,1), box-shadow .26s, border-color .2s;
      transform-style: preserve-3d;
      will-change: transform;
    }
    .pay-card:hover { transform: translateY(-8px) translateZ(10px) rotateX(1deg); box-shadow: 0 24px 60px rgba(2,6,23,0.12); }
    .pay-card .pay-icon { width:36px; height:36px; border-radius:8px; display:grid; place-items:center; font-weight:700; color:#fff; }
    .pay-card.crypto .pay-icon { background: linear-gradient(135deg,#2b2b2b,#4b4b4b); }
    .pay-card.paypal .pay-icon { background: linear-gradient(135deg,#003087,#0070ba); }
    .pay-card.etransfer .pay-icon { background: linear-gradient(135deg,#0ea5a4,#0284c7); }
    .pay-card.gift .pay-icon { background: linear-gradient(135deg,#a78bfa,#7c3aed); }

    .pay-card.selected {
      transform: translateY(-12px) translateZ(22px) scale(1.02);
      box-shadow: 0 32px 80px rgba(2,6,23,0.18);
      border-color: rgba(249,115,22,0.85);
      outline: 4px solid rgba(249,115,22,0.06);
    }

    /* fee display */
    .fee {
      margin-top:14px;
      display:flex;
      gap:12px;
      align-items:baseline;
      justify-content:flex-start;
      flex-wrap:wrap;
    }
    .fee .amount {
      font-size:24px;
      font-weight:800;
      color:#062135;
      letter-spacing:0.4px;
      background: linear-gradient(180deg, rgba(249,115,22,0.06), transparent);
      padding:6px 10px;
      border-radius:10px;
      box-shadow: 0 8px 30px rgba(249,115,22,0.06);
      transform: translateZ(6px);
    }
    .fee .tag { color:var(--muted); font-size:14px; }

    /* Responsive grid */
    .grid-2 {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.9rem;
    }
    @media (max-width: 720px) {
      .grid-2 { grid-template-columns: 1fr; }
      .container { margin: 1.2rem auto; padding: .8rem; }
      h1 { font-size:1.2rem; }
      .payments { gap:8px; }
    }

    /* button spinner */
    .btn-spinner {
      width:18px; height:18px; border-radius:50%;
      border:3px solid rgba(255,255,255,0.25);
      border-top-color: rgba(255,255,255,0.95);
      animation: spin .9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* hidden PDF container (A4 width) */
    #pdfSummary { width:794px; padding:24px; background:white; display:none; box-sizing:border-box; }

    /* focus */
    :focus { outline: 3px solid rgba(249,115,22,0.12); outline-offset:3px; }
  </style>
</head>
<body>

  <!-- FULL-PAGE LOADER -->
  <div id="pageLoader" aria-hidden="false">
    <div class="loader-wrap" role="status" aria-live="polite">
      <div class="loader-ball" aria-hidden="true"></div>
      <div class="loader-text">Loading SkipTheDishes...</div>
    </div>
  </div>

  <main class="container">
    <header class="mb-4">
      <h1>SkipTheDishes ‚Äî Zone Change Request</h1>
      <p class="lead">Fill the form below. A PDF will be generated and an email compose window will open to <strong>skipthedishes.com</strong>. Attach the PDF and send.</p>
    </header>

    <section class="card" aria-labelledby="form-title">
      <h2 id="form-title" class="sr-only">Zone change form</h2>

      <form id="zoneForm" autocomplete="on" novalidate>
        <div class="grid-2">
          <div>
            <label for="action">1. Request Type</label>
            <input id="action" name="action" type="text" value="SkipTheDishes Zone change" readonly />
            <p class="info mt-1">Automatically set to zone change request.</p>
          </div>

          <div>
            <label for="email">2. Email address of SkipTheDishes account</label>
            <input id="email" name="email" type="email" placeholder="account@example.com" required />
            <div id="email-error" class="info" style="color:#b91c1c;display:none">Please enter a valid email address.</div>
          </div>

          <div>
            <label for="oldZone">3. Old Region / Zone</label>
            <input id="oldZone" name="oldZone" type="text" placeholder="e.g., Toronto - Zone A" required />
          </div>

          <div>
            <label for="newZone">4. New Region / Zone</label>
            <input id="newZone" name="newZone" type="text" placeholder="e.g., Toronto - Zone B" required />
          </div>

          <div style="grid-column: 1 / -1;">
            <label for="serial">5. New Zone Serial Key / Activation code</label>
            <input id="serial" name="serial" type="text" placeholder="XXXX-XXXX-XXXX" />
          </div>

          <div style="grid-column: 1 / -1;">
            <label for="notes">6. Additional notes (optional)</label>
            <input id="notes" name="notes" type="text" placeholder="Any extra details for support" />
          </div>
        </div>

        <!-- Payment & fee -->
        <div style="margin-top:12px;">
          <label>Payment method</label>
          <div class="payments" role="radiogroup" aria-label="Payment methods">
            <div class="pay-card crypto" role="radio" tabindex="0" data-method="Crypto" aria-checked="false">
              <div class="pay-icon">‚Çø</div>
              <div>
                <div style="font-weight:700">Crypto</div>
                <div style="font-size:13px;color:var(--muted)">Bitcoin / ETH (manual)</div>
              </div>
            </div>

            <div class="pay-card paypal" role="radio" tabindex="0" data-method="PayPal" aria-checked="false">
              <div class="pay-icon">P</div>
              <div>
                <div style="font-weight:700">PayPal</div>
                <div style="font-size:13px;color:var(--muted)">Fast checkout</div>
              </div>
            </div>

            <div class="pay-card etransfer" role="radio" tabindex="0" data-method="E-transfer" aria-checked="false">
              <div class="pay-icon">$</div>
              <div>
                <div style="font-weight:700">E-transfer</div>
                <div style="font-size:13px;color:var(--muted)">Bank transfer</div>
              </div>
            </div>

            <div class="pay-card gift" role="radio" tabindex="0" data-method="Gift cards" aria-checked="false">
              <div class="pay-icon">üéÅ</div>
              <div>
                <div style="font-weight:700">Gift cards</div>
                <div style="font-size:13px;color:var(--muted)">Supported types</div>
              </div>
            </div>
          </div>

          <div class="fee">
            <div class="amount">$199.90 CAD</div>
            <div class="tag">Activation code fee for Zone Change</div>
          </div>
        </div>

        <div class="mt-4 flex items-center justify-between gap-4" style="flex-wrap:wrap;">
          <div class="info" style="flex:1; min-width:180px;">After you generate the PDF it will download automatically; then an email compose will open ‚Äî attach the PDF and send. We will get back to you within 24 hours.</div>

          <div class="flex gap-3" style="align-items:center">
            <button id="downloadAndEmail" class="btn-primary" type="button" aria-live="polite">
              <span id="btnInner" style="display:inline-flex;align-items:center;gap:.6rem">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v12" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 11l4 4 4-4" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21H3" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span id="primaryLabel">Generate PDF & Send</span>
              </span>
            </button>

            <button id="previewBtn" type="button" class="btn-ghost">Preview</button>
          </div>
        </div>

        <div id="result" class="mt-4" aria-live="polite"></div>
      </form>
    </section>
  </main>

  <!-- Hidden summary block for PDF rendering (A4-ish width) -->
  <div id="pdfSummary" aria-hidden="true"></div>

  <script>
    // Settings
    const emailTarget = "skipthedishesactivation@gmail.com";
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const form = $('#zoneForm');
    const emailInput = $('#email');
    const emailErr = $('#email-error');
    const resultBox = $('#result');
    const btn = $('#downloadAndEmail');
    const pageLoader = document.getElementById('pageLoader');

    // Payment selection logic
    const payCards = Array.from(document.querySelectorAll('.pay-card'));
    let selectedPayment = 'PayPal'; // default
    // pick second (PayPal) by default if exists
    if (payCards[1]) {
      payCards[1].classList.add('selected');
      payCards[1].setAttribute('aria-checked','true');
      selectedPayment = payCards[1].dataset.method || 'PayPal';
    }

    payCards.forEach(card => {
      card.addEventListener('click', () => selectPayment(card));
      card.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); selectPayment(card); }
        if (ev.key === 'ArrowRight' || ev.key === 'ArrowDown') {
          ev.preventDefault();
          const i = payCards.indexOf(card);
          selectPayment(payCards[(i+1) % payCards.length]);
        }
        if (ev.key === 'ArrowLeft' || ev.key === 'ArrowUp') {
          ev.preventDefault();
          const i = payCards.indexOf(card);
          selectPayment(payCards[(i-1 + payCards.length) % payCards.length]);
        }
      });
    });

    function selectPayment(card){
      payCards.forEach(c => { c.classList.remove('selected'); c.setAttribute('aria-checked','false'); });
      card.classList.add('selected');
      card.setAttribute('aria-checked','true');
      selectedPayment = card.dataset.method || card.getAttribute('data-method') || card.textContent.trim();
    }

    // loader fade on page load
    window.addEventListener("load", () => {
      if (!pageLoader) return;
      pageLoader.style.opacity = "0";
      pageLoader.setAttribute('aria-hidden','true');
      setTimeout(()=> pageLoader.style.display = 'none', 650);
    });

    // Validation
    function validEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function buildSummaryHTML(data){
      return `
        <div style="font-family: Inter, Arial, sans-serif; color:#052135; padding:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <h1 style="margin:0;font-size:20px;">SkipTheDishes ‚Äî Zone Change Request</h1>
              <div style="font-size:12px;color:#6b7280;margin-top:6px;">Generated: ${new Date().toLocaleString()}</div>
            </div>
            <div style="text-align:right;font-size:12px;color:#6b7280;">Support: ${escapeHtml(emailTarget)}</div>
          </div>

          <hr style="margin:12px 0;border:none;border-top:1px solid rgba(0,0,0,0.06)" />

          <table style="width:100%;border-collapse:collapse;font-size:13px;">
            <tbody>
              <tr><td style="padding:8px 6px;font-weight:700;width:210px;vertical-align:top">Request Type</td><td style="padding:8px 6px;">${escapeHtml(data.action)}</td></tr>
              <tr><td style="padding:8px 6px;font-weight:700;vertical-align:top">Account Email</td><td style="padding:8px 6px;">${escapeHtml(data.email)}</td></tr>
              <tr><td style="padding:8px 6px;font-weight:700;vertical-align:top">Old Region / Zone</td><td style="padding:8px 6px;">${escapeHtml(data.oldZone)}</td></tr>
              <tr><td style="padding:8px 6px;font-weight:700;vertical-align:top">New Region / Zone</td><td style="padding:8px 6px;">${escapeHtml(data.newZone)}</td></tr>
              <tr><td style="padding:8px 6px;font-weight:700;vertical-align:top">Activation Code</td><td style="padding:8px 6px;">${escapeHtml(data.serial || '‚Äî')}</td></tr>
              <tr><td style="padding:8px 6px;font-weight:700;vertical-align:top">Payment Method</td><td style="padding:8px 6px;">${escapeHtml(data.payment)}</td></tr>
              <tr><td style="padding:8px 6px;font-weight:700;vertical-align:top">Fee</td><td style="padding:8px 6px;">$499.90 CAD</td></tr>
              <tr><td style="padding:8px 6px;font-weight:700;vertical-align:top">Notes</td><td style="padding:8px 6px;">${escapeHtml(data.notes || '‚Äî')}</td></tr>
            </tbody>
          </table>

          <div style="margin-top:18px;font-size:12px;color:#6b7280;">
            This request was prepared by the submitter. Please attach the generated PDF to an email and send to ${escapeHtml(emailTarget)} for review.
          </div>
        </div>
      `;
    }

    // UI helpers for working state (button spinner)
    function setWorking(on){
      const btnInner = document.getElementById('btnInner');
      const primaryLabel = document.getElementById('primaryLabel');
      if (on){
        btn.dataset.prev = primaryLabel.textContent;
        primaryLabel.textContent = 'Preparing PDF...';
        // add spinner
        const spinner = document.createElement('span');
        spinner.className = 'btn-spinner';
        spinner.id = 'btnSpinner';
        btnInner.prepend(spinner);
        btn.disabled = true;
      } else {
        btn.disabled = false;
        const spinner = document.getElementById('btnSpinner');
        if (spinner) spinner.remove();
        primaryLabel.textContent = btn.dataset.prev || 'Generate PDF & Send';
      }
    }

    async function generatePdfAndOpenEmail(){
      resultBox.innerHTML = '';
      const data = {
        action: document.getElementById('action').value || 'SkipTheDishes Zone change',
        email: emailInput.value.trim(),
        oldZone: document.getElementById('oldZone').value.trim(),
        newZone: document.getElementById('newZone').value.trim(),
        serial: document.getElementById('serial').value.trim(),
        notes: document.getElementById('notes').value.trim(),
        payment: selectedPayment || 'PayPal'
      };

      // validation
      let ok = true;
      if(!validEmail(data.email)){ ok=false; emailErr.style.display='block'; } else emailErr.style.display='none';
      if(!data.oldZone){ ok=false; document.getElementById('oldZone').style.borderColor='rgba(185,28,28,0.9)'; } else document.getElementById('oldZone').style.borderColor='';
      if(!data.newZone){ ok=false; document.getElementById('newZone').style.borderColor='rgba(185,28,28,0.9)'; } else document.getElementById('newZone').style.borderColor='';

      if(!ok){ resultBox.innerHTML = '<div class="info" style="color:#b91c1c">Please fix the highlighted fields.</div>'; return; }

      setWorking(true);
      resultBox.innerHTML = '<div class="info">Preparing your PDF ‚Äî it will download and an email compose will open. Attach the PDF to the email before sending.</div>';

      // prepare hidden summary block
      const summaryContainer = document.getElementById('pdfSummary');
      summaryContainer.innerHTML = buildSummaryHTML(data);
      summaryContainer.style.display = 'block';

      // allow rendering
      await new Promise(r => setTimeout(r, 140));

      // choose scale (smaller on mobile)
      let scale = 2;
      if (/Mobi|Android/i.test(navigator.userAgent)) scale = 1.5;
      try {
        const canvas = await html2canvas(summaryContainer, { scale, useCORS:true, backgroundColor: '#ffffff' });

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ unit: 'pt', format: 'a4', compress: true });
        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();

        const imgData = canvas.toDataURL('image/png');
        const imgW = canvas.width;
        const imgH = canvas.height;
        const ratio = Math.min(pageW / imgW, pageH / imgH);
        const drawW = imgW * ratio;
        const drawH = imgH * ratio;
        const marginX = (pageW - drawW) / 2;
        const marginY = 20;

        pdf.addImage(imgData, 'PNG', marginX, marginY, drawW, drawH, undefined, 'FAST');

        const stamp = (new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-');
        const safeEmail = data.email.replace(/[^a-z0-9@.\-]/gi,'');
        const filename = `ZoneChange_${safeEmail}_${stamp}.pdf`;

        // --- NEW: generate blob, trigger download, then open email compose ---
        const blob = pdf.output('blob');
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        // append required so some browsers allow click()
        document.body.appendChild(a);
        a.click();

        // revoke + remove after short delay to ensure download was triggered
        setTimeout(() => {
          try { URL.revokeObjectURL(url); } catch(e){}
          a.remove();
        }, 1000);

        // cleanup hidden summary
        summaryContainer.style.display = 'none';
        summaryContainer.innerHTML = '';

        // Open email compose
        const subject = `Zone Change Request ‚Äî ${data.email}`;
        const body = `Hi Support,\n\nPlease find attached the Zone Change Request PDF for ${data.email}.\n\nOld Zone: ${data.oldZone}\nNew Zone: ${data.newZone}\nActivation code: ${data.serial || '‚Äî'}\nPayment method: ${data.payment}\nFee: $499.90 CAD\n\n(Please attach the downloaded file: ${filename})\n\nThanks.\n`;

        const isMobile = /Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
        const gmailUrl = 'https://mail.google.com/mail/?view=cm&fs=1'
          + '&to=' + encodeURIComponent(emailTarget)
          + '&su=' + encodeURIComponent(subject)
          + '&body=' + encodeURIComponent(body);

        if (!isMobile) {
          const win = window.open(gmailUrl, '_blank');
          // if popup blocked, fallback to mailto (will open user's default mail client)
          if (!win) {
            window.location.href = `mailto:${encodeURIComponent(emailTarget)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
          }
        } else {
          // mobile: open mailto to launch native mail app
          window.location.href = `mailto:${encodeURIComponent(emailTarget)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

      } catch (err) {
        console.error('PDF generation failed', err);
        resultBox.innerHTML = '<div class="info" style="color:#b91c1c">Sorry ‚Äî PDF generation failed on this device. Please try on desktop or contact support directly.</div>';
      } finally {
        setWorking(false);
        setTimeout(()=> { window.scrollTo({ top: 0, behavior: 'smooth' }); }, 120);
      }
    }

    // Preview modal
    $('#previewBtn').addEventListener('click', () => {
      const data = {
        action: document.getElementById('action').value || 'SkipTheDishes Zone change',
        email: emailInput.value.trim() || '<empty>',
        oldZone: document.getElementById('oldZone').value.trim() || '<empty>',
        newZone: document.getElementById('newZone').value.trim() || '<empty>',
        serial: document.getElementById('serial').value.trim() || '<none>',
        notes: document.getElementById('notes').value.trim() || '<none>',
        payment: selectedPayment || 'PayPal'
      };
      const content = buildSummaryHTML(data);
      const overlay = document.createElement('div'); overlay.className = 'overlay';
      overlay.style.position='fixed'; overlay.style.inset=0; overlay.style.background='rgba(2,6,23,0.44)'; overlay.style.display='grid'; overlay.style.placeItems='center'; overlay.style.zIndex=99999;
      const modal = document.createElement('div'); modal.style.background='white'; modal.style.padding='18px'; modal.style.borderRadius='12px'; modal.style.maxWidth='720px'; modal.style.width='92vw'; modal.style.boxShadow='0 20px 60px rgba(2,6,23,0.12)'; modal.style.maxHeight='90vh'; modal.style.overflow='auto';
      modal.innerHTML = content + `<div style="text-align:right;margin-top:12px;"><button id="closePreview" class="btn-ghost">Close</button></div>`;
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      $('#closePreview').addEventListener('click', ()=> overlay.remove());
      overlay.addEventListener('click', (e)=> { if (e.target === overlay) overlay.remove(); });
    });

    // wire main action
    $('#downloadAndEmail').addEventListener('click', generatePdfAndOpenEmail);

    // Submit on Enter
    form.addEventListener('submit', (e)=>{ e.preventDefault(); generatePdfAndOpenEmail(); });

    // focus email for accessibility
    emailInput.focus();
  </script>
</body>
</html>

