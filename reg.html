<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SkipTheDishes — Zone Change Request (PDF + Email)</title>

  <!-- Tailwind (for quick, responsive utilities) -->
  <script src="https://cdn.tailwindcss.com"></script>

<style>
  /* FULL-PAGE LOADER */
  #pageLoader {
    position: fixed;
    inset: 0;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999999;
    transition: opacity .6s ease;
  }

  /* 3D PULSE BALL */
  .loader-ball {
    width: 28px;
    height: 28px;
    background: #f97316;
    border-radius: 50%;
    animation: pop3D 0.8s infinite ease-in-out;
  }

  @keyframes pop3D {
    0% {
      transform: scale(1) translateZ(0);
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }
    50% {
      transform: scale(1.4) translateZ(30px);
      box-shadow: 0 12px 24px rgba(249,115,22,0.25);
    }
    100% {
      transform: scale(1) translateZ(0);
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }
  }

  /* YOUR PAGE STYLE BELOW (kept simple for now) */
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    margin: 0;
    padding: 0;
    background: #f8f9fb;
  }

  .container {
    max-width: 460px;
    margin: 40px auto;
    background: #fff;
    padding: 28px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.06);
  }

  h2 {
    text-align: center;
    margin-bottom: 20px;
    font-weight: 700;
    color: #111;
  }

  label {
    font-weight: 600;
    margin-top: 14px;
    display: block;
    color: #333;
  }

  input {
    width: 100%;
    padding: 12px;
    margin-top: 6px;
    border-radius: 10px;
    border: 1px solid #ddd;
    font-size: 16px;
    outline: none;
  }

  input:focus {
    border-color: #2563eb;
  }

  /* 3D BUTTON */
  .submitBtn {
    width: 100%;
    margin-top: 22px;
    padding: 14px;
    font-size: 18px;
    background: #111;
    color: white;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    transition: transform .15s ease, box-shadow .15s ease;
    box-shadow: 0 6px 0 #000000;
  }

  .submitBtn:active {
    transform: translateY(4px);
    box-shadow: 0 2px 0 #000000;
  }
</style>

  <!-- html2canvas and jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <meta name="theme-color" content="#f97316" />

  <style>
    :root{
      --accent: #f97316;
      --accent-dark: #c65308;
      --muted: #6b7280;
      --bg: #fbfcff;
      --card-radius: 14px;
    }

    html,body { height:100%; }
    body{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#ffffff,var(--bg));
      color: #052135;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      margin:0;
      padding:0;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
    }

    /* Layout container */
    .container {
      max-width: 980px;
      margin: 1.8rem auto;
      padding: 1rem;
    }

    h1 { font-weight: 800; font-size: 1.35rem; margin:0; color:#052135; }
    .lead { color:var(--muted); font-size: .95rem; margin-top:.45rem; }

    /* Card */
    .card {
      background: linear-gradient(180deg,#fff,#fbfdff);
      border-radius: var(--card-radius);
      padding: 1rem;
      box-shadow: 0 12px 36px rgba(4,10,30,0.06);
      overflow: visible;
      transform-style: preserve-3d;
    }

    label { display:block; font-weight: 600; color:#0f172a; margin-bottom:.35rem; font-size:.95rem; }
    input[type="text"], input[type="email"] {
      width:100%;
      padding:.7rem .85rem;
      border-radius: 10px;
      border: 1px solid rgba(2,6,23,0.06);
      background: #fff;
      font-size: 1rem;
    }
    input[readonly] { background:#f6f7fb; color:#39404b; cursor:default; }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(180deg,var(--accent),var(--accent-dark));
      color:white;
      padding:.75rem 1rem;
      border-radius: 12px;
      font-weight:700;
      border:none;
      box-shadow: 0 12px 36px rgba(249,115,22,0.18);
      display:inline-flex;
      gap:.6rem;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .12s ease, opacity .12s;
    }
    .btn-primary:active { transform: translateY(2px); }
    .btn-primary[disabled] { opacity:.6; cursor:not-allowed; transform:none; box-shadow:none; }

    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(2,6,23,0.06);
      padding:.6rem .9rem;
      border-radius:10px;
      cursor:pointer;
    }

    .info {
      font-size:.94rem; color:var(--muted);
    }

    /* Notice */
    .notice {
      padding:.85rem;
      border-radius:10px;
      background: #f3fbff;
      border: 1px solid rgba(2,6,23,0.04);
      color:#052135;
    }

    /* Responsive grid: 2 columns on >=720px, 1 column on small screens */
    .grid-2 {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.9rem;
    }
    @media (max-width: 720px) {
      .grid-2 { grid-template-columns: 1fr; }
      .btn-stack { display:flex; flex-direction:column; gap:.6rem; width:100%; }
      .btn-stack .btn-primary, .btn-stack .btn-ghost { width:100%; }
      .container { margin: 1.2rem auto; padding: .8rem; }
      h1 { font-size:1.2rem; }
    }

    /* modal overlay for preview */
    .overlay {
      position:fixed; inset:0; display:grid; place-items:center;
      background: rgba(2,6,23,0.44); z-index:9999;
    }
    .modal {
      background:white; padding:1rem; border-radius:12px; max-width:92vw; width:720px; box-shadow:0 20px 60px rgba(2,6,23,0.12);
      overflow:auto; max-height:90vh;
    }

    /* hidden PDF container (kept large for quality) */
    #pdfSummary { width:794px; padding:24px; background:white; display:none; box-sizing:border-box; }

    /* focus */
    :focus { outline: 3px solid rgba(249,115,22,0.12); outline-offset:3px; }

  </style>
</head>
<body>

  <main class="container">
    <header class="mb-4">
      <h1>SkipTheDishes — Zone Change Request</h1>
      <p class="lead">Fill the form below. The page will generate a PDF and then open an email compose prefilled to <strong>skipthedishes.com</strong>. On mobile the native mail app will open (attach the downloaded PDF before sending).</p>
    </header>

    <section class="card" aria-labelledby="form-title">
      <h2 id="form-title" class="sr-only">Zone change form</h2>

      <form id="zoneForm" autocomplete="on" novalidate>
        <div class="grid-2">
          <div>
            <label for="action">1. Request Type</label>
            <input id="action" name="action" type="text" value="SkipTheDishes Zone change" readonly />
            <p class="info mt-1">Automatically set to zone change request.</p>
          </div>

          <div>
            <label for="email">2. Email address of SkipTheDishes account</label>
            <input id="email" name="email" type="email" placeholder="account@example.com" required />
            <div id="email-error" class="info" style="color:#b91c1c;display:none">Please enter a valid email address.</div>
          </div>

          <div>
            <label for="oldZone">3. Old Region / Zone</label>
            <input id="oldZone" name="oldZone" type="text" placeholder="e.g., Toronto - Zone A" required />
          </div>

          <div>
            <label for="newZone">4. New Region / Zone</label>
            <input id="newZone" name="newZone" type="text" placeholder="e.g., Toronto - Zone B" required />
          </div>

          <div style="grid-column: 1 / -1;">
            <label for="serial">5. New Zone Serial Key / Activation code</label>
            <input id="serial" name="serial" type="text" placeholder="XXXX-XXXX-XXXX" />
          </div>

          <div style="grid-column: 1 / -1;">
            <label for="notes">6. Additional notes (optional)</label>
            <input id="notes" name="notes" type="text" placeholder="Any extra details for support" />
          </div>
        </div>

        <div class="mt-4 flex items-center justify-between gap-4" style="flex-wrap:wrap;">
          <div class="info" style="flex:1; min-width:180px;">After you generate the PDF it will download automatically; then an email compose will open — attach the PDF and send, We will get back to you within 24 hours of application.</div>

          <div class="flex gap-3 btn-stack" style="align-items:center">
            <button id="downloadAndEmail" class="btn-primary" type="button" aria-live="polite">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v12" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 11l4 4 4-4" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21H3" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
              <span id="primaryLabel">Generate PDF & Send</span>
            </button>

            <button id="previewBtn" type="button" class="btn-ghost">Preview</button>
          </div>
        </div>

        <div id="result" class="mt-4" aria-live="polite"></div>
      </form>
    </section>
  </main>

  <!-- Hidden summary block for PDF rendering (A4-ish width) -->
  <div id="pdfSummary" aria-hidden="true"></div>
window.addEventListener("load", () => {
    const loader = document.getElementById("pageLoader");
    loader.style.opacity = "0";

    setTimeout(() => {
      loader.style.display = "none";
    }, 600);
  });
  <script>
    // Settings
    const emailTarget = "SkipTheDishesActivation@gmail.com";
    const $ = sel => document.querySelector(sel);
    const form = $('#zoneForm');
    const emailInput = $('#email');
    const emailErr = $('#email-error');
    const resultBox = $('#result');
    const btn = $('#downloadAndEmail');
    const primaryLabel = $('#primaryLabel');

    // Validation
    function validEmail(v){
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function buildSummaryHTML(data){
      return `
        <div style="font-family: Inter, Arial, sans-serif; color:#052135; padding:8px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <h1 style="margin:0;font-size:20px;">SkipTheDishes — Zone Change Request</h1>
              <div style="font-size:12px;color:#6b7280;margin-top:6px;">Generated: ${new Date().toLocaleString()}</div>
            </div>
            <div style="text-align:right;font-size:12px;color:#6b7280;">Support: ${escapeHtml(emailTarget)}</div>
          </div>

          <hr style="margin:12px 0;border:none;border-top:1px solid rgba(0,0,0,0.06)" />

          <table style="width:100%;border-collapse:collapse;font-size:13px;">
            <tbody>
              <tr><td style="padding:8px 6px;font-weight:700;width:210px;vertical-align:top">Request Type</td><td style="padding:8px 6px;">${escapeHtml(data.action)}</td></tr>
              <tr><td style="padding:8px 6px;font-weight:700;vertical-align:top">Account Email</td><td style="padding:8px 6px;">${escapeHtml(data.email)}</td></tr>
              <tr><td style="padding:8px 6px;font-weight:700;vertical-align:top">Old Region / Zone</td><td style="padding:8px 6px;">${escapeHtml(data.oldZone)}</td></tr>
              <tr><td style="padding:8px 6px;font-weight:700;vertical-align:top">New Region / Zone</td><td style="padding:8px 6px;">${escapeHtml(data.newZone)}</td></tr>
              <tr><td style="padding:8px 6px;font-weight:700;vertical-align:top">Activation Code</td><td style="padding:8px 6px;">${escapeHtml(data.serial || '—')}</td></tr>
              <tr><td style="padding:8px 6px;font-weight:700;vertical-align:top">Notes</td><td style="padding:8px 6px;">${escapeHtml(data.notes || '—')}</td></tr>
            </tbody>
          </table>

          <div style="margin-top:18px;font-size:12px;color:#6b7280;">
            This request was prepared by the submitter. Please attach the generated PDF to an email and send to ${escapeHtml(emailTarget)} for review.
          </div>
        </div>
      `;
    }

    // toggle button disabled state
    function setWorking(on){
      btn.disabled = !!on;
      primaryLabel.textContent = on ? 'Preparing PDF...' : 'Generate PDF & Email';
    }

    async function generatePdfAndOpenEmail(){
      resultBox.innerHTML = '';
      const data = {
        action: document.getElementById('action').value || 'SkipTheDishes Zone change',
        email: emailInput.value.trim(),
        oldZone: document.getElementById('oldZone').value.trim(),
        newZone: document.getElementById('newZone').value.trim(),
        serial: document.getElementById('serial').value.trim(),
        notes: document.getElementById('notes').value.trim()
      };

      // validation
      let ok = true;
      if(!validEmail(data.email)){ ok=false; emailErr.style.display='block'; } else emailErr.style.display='none';
      if(!data.oldZone){ ok=false; document.getElementById('oldZone').style.borderColor='rgba(185,28,28,0.9)'; } else document.getElementById('oldZone').style.borderColor='';
      if(!data.newZone){ ok=false; document.getElementById('newZone').style.borderColor='rgba(185,28,28,0.9)'; } else document.getElementById('newZone').style.borderColor='';

      if(!ok){ resultBox.innerHTML = '<div class="notice" style="border-left:4px solid #b91c1c">Please fix the highlighted fields.</div>'; return; }

      setWorking(true);
      resultBox.innerHTML = '<div class="notice">Preparing your PDF — it will download and an email compose will open. Remember to attach the downloaded PDF to the email before sending.</div>';

      // prepare hidden summary block
      const summaryContainer = document.getElementById('pdfSummary');
      summaryContainer.innerHTML = buildSummaryHTML(data);
      summaryContainer.style.display = 'block';

      // small delay for fonts/rendering to settle
      await new Promise(r => setTimeout(r, 140));

      // use html2canvas. On mobile lowering scale can help memory limits; fallback accordingly
      let scale = 2;
      if (/Mobi|Android/i.test(navigator.userAgent)) scale = 1.5; // mobile memory-friendly
      try {
        const canvas = await html2canvas(summaryContainer, { scale, useCORS:true, backgroundColor: '#ffffff' });

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ unit: 'pt', format: 'a4', compress: true });
        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();

        const imgData = canvas.toDataURL('image/png');
        const imgW = canvas.width;
        const imgH = canvas.height;
        const ratio = Math.min(pageW / imgW, pageH / imgH);
        const drawW = imgW * ratio;
        const drawH = imgH * ratio;
        const marginX = (pageW - drawW) / 2;
        const marginY = 20;

        pdf.addImage(imgData, 'PNG', marginX, marginY, drawW, drawH, undefined, 'FAST');

        const stamp = (new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-');
        const safeEmail = data.email.replace(/[^a-z0-9@.\-]/gi,'');
        const filename = `ZoneChange_${safeEmail}_${stamp}.pdf`;

        // trigger download
        pdf.save(filename);

        // cleanup
        summaryContainer.style.display = 'none';
        summaryContainer.innerHTML = '';

        // Open email compose
        const subject = `Zone Change Request — ${data.email}`;
        const body = `Hi Support,\n\nPlease find attached the Zone Change Request PDF for ${data.email}.\n\nOld Zone: ${data.oldZone}\nNew Zone: ${data.newZone}\nActivation code: ${data.serial || '—'}\n\n(Please attach the downloaded file: ${filename})\n\nThanks.\n`;

        // Use native mail app on mobile (mailto). Use Gmail web compose on desktop where available.
        const isMobile = /Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
        const gmailUrl = 'https://mail.google.com/mail/?view=cm&fs=1'
          + '&to=' + encodeURIComponent(emailTarget)
          + '&su=' + encodeURIComponent(subject)
          + '&body=' + encodeURIComponent(body);

        if (!isMobile) {
          // try opening Gmail web compose first (new tab). If popup blocked, fallback to mailto.
          const win = window.open(gmailUrl, '_blank');
          if (!win) {
            // popup blocked - fallback
            window.location.href = `mailto:${encodeURIComponent(emailTarget)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
          }
        } else {
          // on mobile: open mailto to trigger default mail app
          window.location.href = `mailto:${encodeURIComponent(emailTarget)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

      } catch (err) {
        console.error('PDF generation failed', err);
        resultBox.innerHTML = '<div class="notice" style="border-left:4px solid #b91c1c">Sorry — PDF generation failed on this device. Please try on desktop or contact support directly.</div>';
      } finally {
        setWorking(false);
        setTimeout(()=> { window.scrollTo({ top: 0, behavior: 'smooth' }); }, 120);
      }
    }

    // Preview modal
    $('#previewBtn').addEventListener('click', () => {
      const data = {
        action: document.getElementById('action').value || 'SkipTheDishes Zone change',
        email: emailInput.value.trim() || '<empty>',
        oldZone: document.getElementById('oldZone').value.trim() || '<empty>',
        newZone: document.getElementById('newZone').value.trim() || '<empty>',
        serial: document.getElementById('serial').value.trim() || '<none>',
        notes: document.getElementById('notes').value.trim() || '<none>'
      };
      const content = buildSummaryHTML(data);
      const overlay = document.createElement('div'); overlay.className = 'overlay';
      const modal = document.createElement('div'); modal.className = 'modal';
      modal.innerHTML = content + `<div style="text-align:right;margin-top:12px;"><button id="closePreview" class="btn-ghost">Close</button></div>`;
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      $('#closePreview').addEventListener('click', ()=> overlay.remove());
      overlay.addEventListener('click', (e)=> { if (e.target === overlay) overlay.remove(); });
    });

    // wire main action
    $('#downloadAndEmail').addEventListener('click', generatePdfAndOpenEmail);

    // Submit on Enter
    form.addEventListener('submit', (e)=>{ e.preventDefault(); generatePdfAndOpenEmail(); });

    // small accessibility: focus first input
    emailInput.focus();

  </script>
</body>
</html>
